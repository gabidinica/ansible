# Demo Project: Automate Kubernetes Deployment

## ðŸš€ Technologies Used
- Ansible  
- Terraform  
- Kubernetes  
- AWS EKS  
- Python  
- Linux  

## ðŸ“– Project Description
- Provision an **Amazon EKS cluster** using **Terraform**.  
- Use **Ansible Playbooks** to:  
  - Deploy the application in Kubernetes.  
  - Create and manage a new **Kubernetes namespace** for deployment.  

---

## Creating an EKS Cluster with Terraform

To create an EKS cluster using Terraform, we use the program available here:  
[Terraform EKS Cluster Project](https://github.com/gabidinica/terraform/tree/main/eks-cluster-terraform)

### Steps
1. Clone the project locally:
```bash
git clone https://github.com/gabidinica/terraform.git
cd terraform/eks-cluster-terraform
```

2. Initialize terraform:
`terraform init`
3. Apply the configuration:
`terraform apply --auto-approve`
4. Verify the EKS cluster in the AWS Management Console.

After creating the EKS cluster with Terraform, you need to update your kubeconfig file so that `kubectl` can connect to the new cluster.
Run the following command in the Terraform folder:
```bash
aws eks update-kubeconfig \
  --region eu-central-1 \
  --name myapp-eks-cluster \
  --kubeconfig ~/terraform/kubeconfig_myapp-eks-cluster
```

> This generates a kubeconfig file that allows you to interact with the cluster using kubectl.

We use **Ansible** to deploy the application into the EKS cluster.

### Playbook
The deployment is defined in `deploy-to-kubernetes.yaml`.

- The Ansible **k8s module** is used to interact with Kubernetes.  
- In the playbook, update the `kubeconfig` line to point to your **home directory**.  
  This allows Ansible to read the kubeconfig context information from the file, so it can connect to the cluster.

## Checking Required Python Modules for Ansible + Kubernetes

Before running the Ansible playbook, make sure the required Python modules are installed.

### Step 1: Verify modules
Run the following commands in your terminal:

```bash
python3 -c "import yaml"
python3 -c "import kubernetes"
python3 -c "import jsonpatch"
```

> If no error is returned, the module is installed.

### Step 2: Install missing modules:

```bash
pip3 install pyyaml --user
pip3 install kubernetes --user
pip3 install jsonpatch --user
```

### Step 3:Run the verification commands again to ensure all required Python modules are installed:
```bash
python3 -c "import yaml"
python3 -c "import kubernetes"
python3 -c "import jsonpatch"
```

### Step 4: Configure Ansible
In your ansible.cfg, confirm that the inventory file is set correctly: `inventory = hosts`

### Step 5: Execute the Ansible playbook to deploy the application:
```bash
ansible-playbook deploy-to-kubernetes.yaml
```

In your home directory, set the `KUBECONFIG` environment variable to point to the kubeconfig file generated by Terraform:
```bash
export KUBECONFIG=~/terraform/kubeconfig_myapp-eks-cluster
```

> Check that you can connect to the cluster by listing namespaces: `kubectl get namespace`

## Deploy app in new namespace

### Step 1: Update the Playbook
In `deploy-to-kubernetes.yaml`, set the `src` to point to your `nginx-config.yaml` file.  
This ensures Ansible applies the Nginx configuration to the `my-app` namespace.

### Step 2: Run the Playbook
Execute the playbook to deploy the Nginx app:
`ansible-playbook deploy-to-kubernetes.yaml`

### Check the pods and services in the my-app namespace:
```bash
kubectl get pod -n my-app
kubectl get svc -n my-app
```

After deploying Nginx, get the **LoadBalancer IP** of the service and access it in your browser:
> You should see **Welcome to Nginx**

To avoid specifying the kubeconfig every time, set the environment variable in your terminal (Visual Studio or any shell):

```bash
export K8S_AUTH_KUBECONFIG=~/kubeconfig_myapp-eks-cluster
```

Then run the Ansible playbook as usual: `ansible-playbook deploy-to-kubernetes.yaml`
